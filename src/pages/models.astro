---
import Layout from '../layouts/Layout.astro';
import Card from '../components/ui/Card.astro';
import Breadcrumbs from '../components/ui/Breadcrumbs.astro';
import Button from '../components/ui/Button.astro';
import Input from '../components/ui/Input.astro';
import EmptyState from '../components/ui/EmptyState.astro';
import { getModels, getModelUsageCount } from '../lib/db';
import type { Provider } from '../lib/types';

// Get models for initial render
let models: Array<{
  id: string;
  provider: Provider;
  model_name: string;
  is_active: boolean;
  created_at: string;
  usage_count: number;
  notes?: string;
}> = [];

try {
  models = getModels(false).map(m => ({
    id: m.id,
    provider: m.provider,
    model_name: m.model_name,
    is_active: m.is_active,
    created_at: m.created_at,
    notes: m.notes,
    usage_count: getModelUsageCount(m.id)
  }));
} catch {
  // Database may not be initialized
}

const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Models' }
];

// Icon for empty state
const modelIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
</svg>`;
---

<Layout title="Model Management - Eval AI">
  <Breadcrumbs items={breadcrumbItems} />

  <!-- Header -->
  <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold">Model Management</h1>
      <p class="mt-2 text-base-content/70">Configure AI models for evaluation.</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <Button id="import-btn" variant="secondary" size="sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
        Import
      </Button>
      <Button id="export-btn" variant="secondary" size="sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(180 10 10)"/>
        </svg>
        Export
      </Button>
      <Button id="add-model-btn" variant="primary" size="sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
        </svg>
        Add Model
      </Button>
    </div>
  </div>

  <!-- Error Banner -->
  <div id="error-banner" class="hidden alert alert-error mb-6">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span id="error-message"></span>
  </div>

  <!-- Success Banner -->
  <div id="success-banner" class="hidden alert alert-success mb-6">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span id="success-message"></span>
  </div>

  <!-- Add Model Modal -->
  <dialog id="add-model-modal" class="modal">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
      </form>
      <h3 class="font-bold text-lg mb-4">Add New Model</h3>
      <form id="add-model-form" class="space-y-4">
        <div class="form-control w-full">
          <label class="label" for="provider">
            <span class="label-text">Provider</span>
          </label>
          <select id="provider" name="provider" class="select select-bordered w-full" required>
            <option value="">Select a provider...</option>
            <option value="openai">OpenAI (GPT)</option>
            <option value="anthropic">Anthropic (Claude)</option>
            <option value="google">Google (Gemini)</option>
          </select>
        </div>
        <Input
          label="Model Name"
          name="model_name"
          placeholder="e.g. gpt-4o, claude-3-opus-20240229"
          required
        />
        <p class="text-xs text-base-content/50 -mt-2">Must match the provider's API model identifier.</p>
        <Input
          label="API Key"
          name="api_key"
          type="password"
          placeholder="sk-..."
          required
        />
        <p class="text-xs text-base-content/50 -mt-2">Stored securely using AES-256-GCM encryption.</p>
        <div class="form-control w-full">
          <label class="label" for="notes">
            <span class="label-text">Notes (Optional)</span>
          </label>
          <textarea id="notes" name="notes" rows="2" class="textarea textarea-bordered w-full" placeholder="Internal notes about this model..."></textarea>
        </div>
        <div class="modal-action">
          <button type="button" class="btn" onclick="add_model_modal.close()">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Model</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Import File Input (Hidden) -->
  <input type="file" id="import-file" accept=".json" class="hidden" />

  <!-- Models List -->
  <Card>
    {models.length > 0 ? (
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th>Status</th>
              <th>Provider / Model</th>
              <th>Usage</th>
              <th>Created</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="models-body">
            {models.map(model => (
              <tr data-id={model.id}>
                <td>
                  <input
                    type="checkbox"
                    class="toggle toggle-success toggle-active-btn"
                    checked={model.is_active}
                    data-id={model.id}
                    data-active={model.is_active.toString()}
                  />
                </td>
                <td>
                  <div>
                    <div class="font-medium">{model.model_name}</div>
                    <div class="text-sm text-base-content/50 capitalize">{model.provider}</div>
                    {model.notes && <div class="text-xs text-base-content/40 mt-0.5">{model.notes}</div>}
                  </div>
                </td>
                <td class="text-base-content/70">
                  {model.usage_count} evaluations
                </td>
                <td class="text-base-content/70">
                  {new Date(model.created_at).toLocaleDateString()}
                </td>
                <td>
                  <div class="flex justify-end gap-2">
                    <button class="test-btn btn btn-xs btn-ghost text-primary" data-id={model.id}>Test</button>
                    <button class="delete-btn btn btn-xs btn-ghost text-error" data-id={model.id}>Delete</button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    ) : (
      <EmptyState
        title="No models configured"
        description="Add your first AI model to start evaluating."
        icon={modelIcon}
        action={{ label: 'Add Model', onClick: "document.getElementById('add-model-modal').showModal()" }}
      />
    )}
  </Card>
</Layout>

<script>
  // Elements
  const addModelBtn = document.getElementById('add-model-btn') as HTMLButtonElement;
  const addModelModal = document.getElementById('add-model-modal') as HTMLDialogElement;
  const addModelForm = document.getElementById('add-model-form') as HTMLFormElement;
  const errorBanner = document.getElementById('error-banner') as HTMLDivElement;
  const errorMessage = document.getElementById('error-message') as HTMLSpanElement;
  const successBanner = document.getElementById('success-banner') as HTMLDivElement;
  const successMessage = document.getElementById('success-message') as HTMLSpanElement;
  const importBtn = document.getElementById('import-btn') as HTMLButtonElement;
  const exportBtn = document.getElementById('export-btn') as HTMLButtonElement;
  const importFile = document.getElementById('import-file') as HTMLInputElement;

  // Show modal
  if (addModelBtn) {
    addModelBtn.addEventListener('click', () => {
      addModelModal.showModal();
    });
  }

  // Helper functions
  function showError(message: string) {
    errorMessage.textContent = message;
    errorBanner.classList.remove('hidden');
    successBanner.classList.add('hidden');
    window.scrollTo(0, 0);
  }

  function showSuccess(message: string) {
    successMessage.textContent = message;
    successBanner.classList.remove('hidden');
    errorBanner.classList.add('hidden');
    window.scrollTo(0, 0);
    setTimeout(() => successBanner.classList.add('hidden'), 5000);
  }

  // Add Model Submit
  addModelForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = addModelForm.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Verifying & Adding...';
    errorBanner.classList.add('hidden');

    const formData = new FormData(addModelForm);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/models', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (!response.ok) {
         throw new Error(result.message || result.error || 'Failed to add model');
      }

      // Close modal
      addModelModal.close();
      addModelForm.reset();

      showSuccess(`Model ${result.model_name} added successfully!`);
      // Refresh page to show new model
      setTimeout(() => window.location.reload(), 1500);

    } catch (error) {
      showError(error instanceof Error ? error.message : 'An error occurred');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  // Toggle Active Status
  document.querySelectorAll('.toggle-active-btn').forEach(btn => {
    btn.addEventListener('change', async (e) => {
      const target = e.currentTarget as HTMLInputElement;
      const id = target.dataset.id;
      const newActive = target.checked;

      try {
        const response = await fetch(`/api/models/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: newActive })
        });

        if (!response.ok) {
          throw new Error('Failed to update status');
        }

        target.dataset.active = newActive.toString();

      } catch (error) {
        showError('Failed to update model status');
        // Revert the toggle
        target.checked = !newActive;
      }
    });
  });

  // Delete Model
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const id = target.dataset.id;

      if (!confirm('Are you sure you want to delete this model? This action cannot be undone.')) {
        return;
      }

      target.disabled = true;
      target.textContent = '...';

      try {
        const response = await fetch(`/api/models/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to delete model');
        }

        // Remove row
        target.closest('tr')?.remove();
        showSuccess('Model deleted successfully');

        // If no rows left, reload to show empty state
        if (document.querySelectorAll('tbody tr').length === 0) {
          window.location.reload();
        }

      } catch (error) {
        showError(error instanceof Error ? error.message : 'Failed to delete model');
        target.disabled = false;
        target.textContent = 'Delete';
      }
    });
  });

  // Test Connection
  document.querySelectorAll('.test-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const id = target.dataset.id;

      const originalText = target.textContent;
      target.disabled = true;
      target.textContent = 'Testing...';

      try {
        const response = await fetch(`/api/models/${id}/test-connection`, {
          method: 'POST'
        });

        const data = await response.json();

        if (!response.ok || !data.valid) {
          throw new Error(data.message || 'Connection test failed');
        }

        showSuccess('Connection successful! Model is ready to use.');

      } catch (error) {
        showError(error instanceof Error ? error.message : 'Connection failed');
      } finally {
        target.disabled = false;
        target.textContent = originalText;
      }
    });
  });

  // Export
  exportBtn.addEventListener('click', async () => {
    try {
      const response = await fetch('/api/models');
      const data = await response.json();

      // Remove sensitive data
      const exportData = data.models.map(({ api_key_encrypted, ...rest }: any) => rest);

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `eval-models-export-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      showError('Failed to export models');
    }
  });

  // Import
  importBtn.addEventListener('click', () => {
    importFile.click();
  });

  importFile.addEventListener('change', async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (event) => {
      try {
        const content = event.target?.result as string;
        const models = JSON.parse(content);

        if (!Array.isArray(models)) {
          throw new Error('Invalid file format: expected an array of models');
        }

        let successCount = 0;
        let failCount = 0;

        importBtn.disabled = true;
        importBtn.textContent = 'Importing...';

        for (const model of models) {
           if (!model.provider || !model.model_name) {
             console.warn('Skipping invalid model entry', model);
             continue;
           }

           if (!model.api_key) {
             console.warn(`Skipping ${model.model_name}: missing API key`);
             failCount++;
             continue;
           }

           try {
             const response = await fetch('/api/models', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({
                 provider: model.provider,
                 model_name: model.model_name,
                 api_key: model.api_key,
                 notes: model.notes
               })
             });

             if (response.ok) successCount++;
             else failCount++;
           } catch {
             failCount++;
           }
        }

        if (successCount > 0) {
          showSuccess(`Imported ${successCount} models. ${failCount > 0 ? `(${failCount} failed)` : ''}`);
          setTimeout(() => window.location.reload(), 2000);
        } else {
          showError(`Import failed. No valid models with API keys found. ${failCount} entries skipped.`);
        }

      } catch (error) {
        showError('Failed to parse import file: ' + (error instanceof Error ? error.message : 'Unknown error'));
      } finally {
        importBtn.disabled = false;
        importBtn.textContent = 'Import';
        importFile.value = '';
      }
    };
    reader.readAsText(file);
  });
</script>
