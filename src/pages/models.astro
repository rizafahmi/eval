---
import Layout from '../layouts/Layout.astro';
import Card from '../components/ui/Card.astro';
import Breadcrumbs from '../components/ui/Breadcrumbs.astro';
import Button from '../components/ui/Button.astro';
import Input from '../components/ui/Input.astro';
import EmptyState from '../components/ui/EmptyState.astro';
import { getModels, getModelUsageCount } from '../lib/db';
import type { Provider } from '../lib/types';

// Get models for initial render
let models: Array<{
  id: string;
  provider: Provider;
  model_name: string;
  is_active: boolean;
  created_at: string;
  usage_count: number;
  notes?: string;
}> = [];

try {
  models = getModels(false).map((m) => ({
    id: m.id,
    provider: m.provider,
    model_name: m.model_name,
    is_active: m.is_active,
    created_at: m.created_at,
    notes: m.notes,
    usage_count: getModelUsageCount(m.id),
  }));
} catch {
  // Database may not be initialized
}

const breadcrumbItems = [{ label: 'Home', href: '/' }, { label: 'Models' }];

// Icon for empty state
const modelIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
</svg>`;
---

<Layout title="Model Management - Eval AI">
  <Breadcrumbs items={breadcrumbItems} />

  <!-- Header -->
  <div class="flex items-center justify-between mb-12 animate-reveal">
    <div class="accent-line">
      <h1
        class="text-5xl md:text-6xl font-display font-semibold tracking-tight mb-4 text-gradient-gold"
      >
        Model Management
      </h1>
      <p class="mt-3 text-base-content/60 text-lg">Configure AI models for evaluation.</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <Button id="import-btn" variant="ghost" size="md">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 mr-2"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
        Import
      </Button>
      <Button id="export-btn" variant="ghost" size="md">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 mr-2"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
            clip-rule="evenodd"
            transform="rotate(180 10 10)"></path>
        </svg>
        Export
      </Button>
      <Button id="add-model-btn" variant="primary" size="md">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 mr-2"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
            clip-rule="evenodd"></path>
        </svg>
        Add Model
      </Button>
    </div>
  </div>

  <!-- Add Model Modal -->
  <dialog id="add-model-modal" class="modal">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
      </form>
      <h3 class="font-display text-2xl font-semibold mb-6 text-gold-accessible">Add New Model</h3>
      <form id="add-model-form" class="space-y-4">
        <div class="form-control w-full">
          <label class="label" for="provider">
            <span class="label-text font-medium">Provider</span>
          </label>
          <select id="provider" name="provider" class="select select-bordered w-full" required>
            <option value="">Select a provider...</option>
            <option value="openai">OpenAI (GPT)</option>
            <option value="anthropic">Anthropic (Claude)</option>
            <option value="google">Google (Gemini)</option>
          </select>
        </div>
        <Input
          label="Model Name"
          name="model_name"
          placeholder="e.g. gpt-4o, claude-3-opus-20240229"
          required
        />
        <p class="text-xs text-base-content/50 -mt-2">
          Must match the provider's API model identifier. Use <a
            href="https://models.dev/"
            target="_new">Models.dev</a
          > to find model ID.
        </p>
        <Input label="API Key" name="api_key" type="password" placeholder="sk-..." required />
        <p class="text-xs text-base-content/50 -mt-2">
          Stored securely using AES-256-GCM encryption.
        </p>
        <div class="form-control w-full">
          <label class="label" for="notes">
            <span class="label-text font-medium">Notes (Optional)</span>
          </label>
          <textarea
            id="notes"
            name="notes"
            rows="2"
            class="textarea textarea-bordered w-full"
            placeholder="Internal notes about this model..."></textarea>
        </div>
        <div class="modal-action">
          <button
            type="button"
            class="btn btn-ghost min-w-24"
            onclick="document.getElementById('add-model-modal').close()">Cancel</button
          >
          <button type="submit" class="btn btn-luxe btn-luxe-primary min-w-24">Add Model</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Import File Input (Hidden) -->
  <input type="file" id="import-file" accept=".json" class="hidden" />

  <!-- Models List -->
  <div class="card-luxe overflow-hidden animate-reveal delay-200">
    {
      models.length > 0 ? (
        <div class="overflow-x-auto">
          <table class="table-luxe table-models">
            <thead>
              <tr>
                <th>Status</th>
                <th>Provider / Model</th>
                <th>Usage</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="models-body">
              {models.map((model) => (
                <tr data-id={model.id}>
                  <td class="text-center">
                    <input
                      type="checkbox"
                      class="toggle toggle-success toggle-sm"
                      checked={model.is_active}
                      data-id={model.id}
                      data-active={model.is_active.toString()}
                    />
                  </td>
                  <td>
                    <div>
                      <div class="font-medium">{model.model_name}</div>
                      <div class="text-sm text-base-content/50 capitalize">{model.provider}</div>
                      {model.notes && (
                        <div class="text-xs text-base-content/40 mt-0.5">{model.notes}</div>
                      )}
                    </div>
                  </td>
                  <td class="text-base-content/70 whitespace-nowrap">
                    {model.usage_count} evaluations
                  </td>
                  <td class="text-base-content/70 whitespace-nowrap">
                    {new Date(model.created_at).toLocaleDateString()}
                  </td>
                  <td>
                    <div class="flex gap-2 whitespace-nowrap">
                      <button class="test-btn btn btn-xs btn-ghost text-primary" data-id={model.id}>
                        Test
                      </button>
                      <button class="delete-btn btn btn-xs btn-ghost text-error" data-id={model.id}>
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <div class="p-16">
          <EmptyState
            title="No models configured"
            description="Add your first AI model to start evaluating."
            icon={modelIcon}
            action={{
              label: 'Add Model',
              onClick: "document.getElementById('add-model-modal').showModal()",
            }}
          />
        </div>
      )
    }
  </div>
</Layout>

<script>
  import { addToast } from '../lib/toastStore';

  // Elements
  const addModelBtn = document.getElementById('add-model-btn') as HTMLButtonElement;
  const addModelModal = document.getElementById('add-model-modal') as HTMLDialogElement;
  const addModelForm = document.getElementById('add-model-form') as HTMLFormElement;
  const importBtn = document.getElementById('import-btn') as HTMLButtonElement;
  const exportBtn = document.getElementById('export-btn') as HTMLButtonElement;
  const importFile = document.getElementById('import-file') as HTMLInputElement;

  // Show modal
  if (addModelBtn) {
    addModelBtn.addEventListener('click', () => {
      addModelModal.showModal();
    });
  }

  // Add Model Submit
  if (addModelForm) {
    addModelForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = addModelForm.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Verifying & Adding...';

      const formData = new FormData(addModelForm);
      const data = Object.fromEntries(formData.entries());

      try {
        const response = await fetch('/api/models', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.message || result.error || 'Failed to add model');
        }

        // Close modal
        addModelModal.close();
        addModelForm.reset();

        addToast(`Model ${result.model_name} added successfully!`, 'success');
        // Refresh page to show new model
        setTimeout(() => window.location.reload(), 1500);
      } catch (error) {
        addToast(error instanceof Error ? error.message : 'An error occurred', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  }

  // Toggle Active Status
  document.querySelectorAll('.toggle').forEach((btn) => {
    btn.addEventListener('change', async (e) => {
      const target = e.currentTarget as HTMLInputElement;
      const id = target.dataset.id;
      const newActive = target.checked;

      try {
        const response = await fetch(`/api/models/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: newActive }),
        });

        if (!response.ok) {
          throw new Error('Failed to update status');
        }

        target.dataset.active = newActive.toString();
      } catch {
        addToast('Failed to update model status', 'error');
        // Revert the toggle
        target.checked = !newActive;
      }
    });
  });

  // Delete Model
  document.querySelectorAll('.delete-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const id = target.dataset.id;

      if (!confirm('Are you sure you want to delete this model? This action cannot be undone.')) {
        return;
      }

      target.disabled = true;
      target.textContent = '...';

      try {
        const response = await fetch(`/api/models/${id}`, {
          method: 'DELETE',
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Failed to delete model');
        }

        // Remove row
        target.closest('tr')?.remove();
        addToast('Model deleted successfully', 'success');

        // If no rows left, reload to show empty state
        if (document.querySelectorAll('tbody tr').length === 0) {
          window.location.reload();
        }
      } catch (error) {
        addToast(error instanceof Error ? error.message : 'Failed to delete model', 'error');
        target.disabled = false;
        target.textContent = 'Delete';
      }
    });
  });

  // Test Connection
  document.querySelectorAll('.test-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const id = target.dataset.id;

      const originalText = target.textContent;
      target.disabled = true;
      target.textContent = 'Testing...';

      try {
        const response = await fetch(`/api/models/${id}/test-connection`, {
          method: 'POST',
        });

        const data = await response.json();

        if (!response.ok || data.status !== 'valid') {
          throw new Error(data.message || 'Connection test failed');
        }

        addToast('Connection successful! Model is ready to use.', 'success');
      } catch (error) {
        addToast(error instanceof Error ? error.message : 'Connection failed', 'error');
      } finally {
        target.disabled = false;
        target.textContent = originalText;
      }
    });
  });

  // Export
  if (exportBtn) {
    exportBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/models');
        const data = await response.json();

        // Remove sensitive data
        const exportData = data.models.map(
          ({ api_key_encrypted: _api_key_encrypted, ...rest }: any) => rest
        );

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `eval-models-export-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch {
        addToast('Failed to export models', 'error');
      }
    });
  }

  // Import
  if (importBtn && importFile) {
    importBtn.addEventListener('click', () => {
      importFile.click();
    });

    importFile.addEventListener('change', async (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const content = event.target?.result as string;
          const models = JSON.parse(content);

          if (!Array.isArray(models)) {
            throw new Error('Invalid file format: expected an array of models');
          }

          let successCount = 0;
          let failCount = 0;

          importBtn.disabled = true;
          importBtn.textContent = 'Importing...';

          for (const model of models) {
            if (!model.provider || !model.model_name) {
              console.warn('Skipping invalid model entry', model);
              continue;
            }

            if (!model.api_key) {
              console.warn(`Skipping ${model.model_name}: missing API key`);
              failCount++;
              continue;
            }

            try {
              const response = await fetch('/api/models', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  provider: model.provider,
                  model_name: model.model_name,
                  api_key: model.api_key,
                  notes: model.notes,
                }),
              });

              if (response.ok) successCount++;
              else failCount++;
            } catch {
              failCount++;
            }
          }

          if (successCount > 0) {
            addToast(
              `Imported ${successCount} models. ${failCount > 0 ? `(${failCount} failed)` : ''}`,
              'success'
            );
            setTimeout(() => window.location.reload(), 2000);
          } else {
            addToast(
              `Import failed. No valid models with API keys found. ${failCount} entries skipped.`,
              'error'
            );
          }
        } catch (error) {
          addToast(
            'Failed to parse import file: ' +
              (error instanceof Error ? error.message : 'Unknown error'),
            'error'
          );
        } finally {
          importBtn.disabled = false;
          importBtn.textContent = 'Import';
          importFile.value = '';
        }
      };
      reader.readAsText(file);
    });
  }
</script>
