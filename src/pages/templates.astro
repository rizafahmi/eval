---
import Layout from '../layouts/Layout.astro';
import Card from '../components/ui/Card.astro';
import Breadcrumbs from '../components/ui/Breadcrumbs.astro';
import Badge from '../components/ui/Badge.astro';
import EmptyState from '../components/ui/EmptyState.astro';
import { getTemplates } from '../lib/db';

// Get templates
let templates: Array<{
  id: string;
  name: string;
  description?: string;
  instruction_text: string;
  model_count: number;
  accuracy_rubric: string;
  created_at: string;
  run_count: number;
}> = [];

try {
  templates = getTemplates().map(t => ({
    id: t.id,
    name: t.name,
    description: t.description,
    instruction_text: t.instruction_text.substring(0, 200),
    model_count: t.model_ids.length,
    accuracy_rubric: t.accuracy_rubric,
    created_at: t.created_at,
    run_count: t.run_count
  }));
} catch {
  // Database may not be initialized
}

const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Templates' }
];

// Icon for empty state
const templateIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
</svg>`;
---

<Layout title="Evaluation Templates - Eval AI">
  <Breadcrumbs items={breadcrumbItems} />

  <div class="mb-8">
    <h1 class="text-3xl font-bold">Evaluation Templates</h1>
    <p class="mt-2 text-base-content/70">Saved evaluation configurations for quick reuse.</p>
  </div>

  <!-- Error Banner -->
  <div id="error-banner" class="hidden alert alert-error mb-6">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span id="error-message"></span>
  </div>

  <!-- Success Banner -->
  <div id="success-banner" class="hidden alert alert-success mb-6">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span id="success-message"></span>
  </div>

  <!-- Templates List -->
  <Card>
    {templates.length > 0 ? (
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>Name</th>
              <th>Instruction Preview</th>
              <th>Models</th>
              <th>Rubric</th>
              <th>Runs</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="templates-body">
            {templates.map(template => (
              <tr data-id={template.id}>
                <td>
                  <div class="font-medium">{template.name}</div>
                  {template.description && (
                    <div class="text-xs text-base-content/50 mt-1">{template.description}</div>
                  )}
                </td>
                <td class="max-w-xs">
                  <div class="truncate text-sm text-base-content/70" title={template.instruction_text}>
                    {template.instruction_text}
                  </div>
                </td>
                <td>{template.model_count}</td>
                <td>
                  <Badge variant="ghost" size="sm">
                    {template.accuracy_rubric.replace('_', ' ')}
                  </Badge>
                </td>
                <td>{template.run_count}</td>
                <td class="text-sm text-base-content/70">
                  {new Date(template.created_at).toLocaleDateString()}
                </td>
                <td>
                  <div class="flex gap-2">
                    <button
                      class="run-btn btn btn-xs btn-ghost text-primary"
                      data-id={template.id}
                    >
                      Run
                    </button>
                    <a
                      href={`/history?template=${template.id}`}
                      class="btn btn-xs btn-ghost text-base-content/70"
                    >
                      History
                    </a>
                    <button
                      class="delete-btn btn btn-xs btn-ghost text-error"
                      data-id={template.id}
                    >
                      Delete
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    ) : (
      <EmptyState
        title="No templates saved"
        description="Complete an evaluation and save it as a template."
        icon={templateIcon}
        action={{ label: 'Go to Evaluate', href: '/' }}
      />
    )}
  </Card>
</Layout>

<script>
  const errorBanner = document.getElementById('error-banner') as HTMLDivElement;
  const errorMessage = document.getElementById('error-message') as HTMLSpanElement;
  const successBanner = document.getElementById('success-banner') as HTMLDivElement;
  const successMessage = document.getElementById('success-message') as HTMLSpanElement;

  function showError(message: string) {
    errorMessage.textContent = message;
    errorBanner.classList.remove('hidden');
    successBanner.classList.add('hidden');
  }

  function showSuccess(message: string) {
    successMessage.textContent = message;
    successBanner.classList.remove('hidden');
    errorBanner.classList.add('hidden');
    setTimeout(() => successBanner.classList.add('hidden'), 5000);
  }

  // Run template
  document.querySelectorAll('.run-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.target as HTMLButtonElement;
      const templateId = target.dataset.id;
      if (!templateId) return;

      target.disabled = true;
      target.textContent = 'Running...';

      try {
        const response = await fetch(`/api/templates/${templateId}/run`, {
          method: 'POST'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to run template');
        }

        // Redirect to home with evaluation ID
        window.location.href = `/?evaluation=${data.evaluation_id}`;
      } catch (error) {
        showError(error instanceof Error ? error.message : 'Failed to run template');
        target.disabled = false;
        target.textContent = 'Run';
      }
    });
  });

  // Delete template
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.target as HTMLButtonElement;
      const templateId = target.dataset.id;
      if (!templateId) return;

      if (!confirm('Are you sure you want to delete this template?')) {
        return;
      }

      target.disabled = true;

      try {
        const response = await fetch(`/api/templates/${templateId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to delete template');
        }

        // Remove row from table
        const row = target.closest('tr');
        if (row) row.remove();

        showSuccess('Template deleted successfully');

        // If no rows left, reload to show empty state
        if (document.querySelectorAll('tbody tr').length === 0) {
          window.location.reload();
        }
      } catch (error) {
        showError(error instanceof Error ? error.message : 'Failed to delete template');
        target.disabled = false;
      }
    });
  });
</script>
