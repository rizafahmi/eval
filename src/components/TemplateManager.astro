---
// src/components/TemplateManager.astro
// Modal to save current evaluation as a reusable template
---

<!-- Template Manager Modal (using HTML Popover API) -->
<div id="template-modal" popover class="bg-white rounded-lg shadow-xl max-w-md w-full mx-auto mt-[10vh] p-0 border-0">
  <form id="template-form">
    <div class="px-4 pt-5 pb-4 sm:p-6">
      <div class="sm:flex sm:items-start">
        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
          <h3 class="text-lg leading-6 font-medium text-gray-900">Save as Template</h3>
          <p class="mt-1 text-sm text-gray-500">Save this evaluation configuration for reuse.</p>

          <div class="mt-4 space-y-4">
            <!-- Template Name -->
            <div>
              <label for="template-name" class="block text-sm font-medium text-gray-700">
                Template Name <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="template-name"
                name="name"
                required
                maxlength="100"
                placeholder="e.g., Code Review Prompt Test"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
              />
            </div>

            <!-- Template Description -->
            <div>
              <label for="template-description" class="block text-sm font-medium text-gray-700">
                Description <span class="text-gray-400">(optional)</span>
              </label>
              <textarea
                id="template-description"
                name="description"
                rows="2"
                maxlength="500"
                placeholder="Brief description of what this template evaluates..."
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
              ></textarea>
            </div>

            <!-- Summary of what will be saved -->
            <div class="bg-gray-50 rounded-md p-3">
              <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Will save:</p>
              <ul id="template-summary" class="mt-2 text-sm text-gray-600 space-y-1">
                <!-- Populated by JavaScript -->
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error message -->
    <div id="template-error" class="hidden px-4 sm:px-6">
      <div class="rounded-md bg-red-50 p-3">
        <p id="template-error-text" class="text-sm text-red-700"></p>
      </div>
    </div>

    <!-- Success message -->
    <div id="template-success" class="hidden px-4 sm:px-6">
      <div class="rounded-md bg-green-50 p-3">
        <p class="text-sm text-green-700">Template saved successfully!</p>
      </div>
    </div>

    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg gap-2">
      <button
        type="submit"
        id="template-submit-btn"
        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Save Template
      </button>
      <button
        type="button"
        id="template-cancel-btn"
        popovertarget="template-modal"
        popovertargetaction="hide"
        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm"
      >
        Cancel
      </button>
    </div>
  </form>
</div>

<script>
  // Template Manager state
  interface TemplateData {
    instruction_text: string;
    model_ids: string[];
    accuracy_rubric: string;
    expected_output: string;
    partial_credit_concepts?: string[];
  }

  let pendingTemplateData: TemplateData | null = null;

  // DOM Elements
  const templateModal = document.getElementById('template-modal') as HTMLElement;
  const templateForm = document.getElementById('template-form') as HTMLFormElement;
  const templateNameInput = document.getElementById('template-name') as HTMLInputElement;
  const templateDescriptionInput = document.getElementById('template-description') as HTMLTextAreaElement;
  const templateSummary = document.getElementById('template-summary') as HTMLUListElement;
  const templateError = document.getElementById('template-error') as HTMLDivElement;
  const templateErrorText = document.getElementById('template-error-text') as HTMLParagraphElement;
  const templateSuccess = document.getElementById('template-success') as HTMLDivElement;
  const templateSubmitBtn = document.getElementById('template-submit-btn') as HTMLButtonElement;

  // Open template modal with evaluation data
  function openTemplateModal(data: TemplateData) {
    pendingTemplateData = data;

    // Reset form
    templateForm.reset();
    templateError.classList.add('hidden');
    templateSuccess.classList.add('hidden');
    templateSubmitBtn.disabled = false;
    templateSubmitBtn.textContent = 'Save Template';

    // Populate summary
    const instructionPreview = data.instruction_text.length > 50
      ? data.instruction_text.substring(0, 50) + '...'
      : data.instruction_text;

    templateSummary.innerHTML = `
      <li><span class="font-medium">Instruction:</span> "${instructionPreview}"</li>
      <li><span class="font-medium">Models:</span> ${data.model_ids.length} selected</li>
      <li><span class="font-medium">Rubric:</span> ${formatRubric(data.accuracy_rubric)}</li>
    `;

    // Show modal
    templateModal.showPopover();
    templateNameInput.focus();
  }

  function formatRubric(rubric: string): string {
    const rubricNames: Record<string, string> = {
      'exact_match': 'Exact Match',
      'partial_credit': 'Partial Credit',
      'semantic_similarity': 'Semantic Similarity'
    };
    return rubricNames[rubric] || rubric;
  }

  // Handle form submission
  templateForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!pendingTemplateData) {
      showTemplateError('No evaluation data to save');
      return;
    }

    const name = templateNameInput.value.trim();
    if (!name) {
      showTemplateError('Template name is required');
      return;
    }

    // Disable submit button
    templateSubmitBtn.disabled = true;
    templateSubmitBtn.textContent = 'Saving...';
    templateError.classList.add('hidden');

    try {
      const response = await fetch('/api/templates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          description: templateDescriptionInput.value.trim() || undefined,
          instruction_text: pendingTemplateData.instruction_text,
          model_ids: pendingTemplateData.model_ids,
          accuracy_rubric: pendingTemplateData.accuracy_rubric,
          expected_output: pendingTemplateData.expected_output,
          partial_credit_concepts: pendingTemplateData.partial_credit_concepts
        })
      });

      const data = await response.json();

      if (response.ok) {
        // Show success message
        templateSuccess.classList.remove('hidden');
        templateSubmitBtn.textContent = 'Saved!';

        // Close modal after delay
        setTimeout(() => {
          templateModal.hidePopover();
          pendingTemplateData = null;
        }, 1500);
      } else {
        showTemplateError(data.message || data.error || 'Failed to save template');
        templateSubmitBtn.disabled = false;
        templateSubmitBtn.textContent = 'Save Template';
      }
    } catch {
      showTemplateError('Network error. Please try again.');
      templateSubmitBtn.disabled = false;
      templateSubmitBtn.textContent = 'Save Template';
    }
  });

  function showTemplateError(message: string) {
    templateErrorText.textContent = message;
    templateError.classList.remove('hidden');
  }

  // Expose function globally for index.astro to call
  (window as any).openTemplateModal = openTemplateModal;
</script>
