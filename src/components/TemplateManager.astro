---
// src/components/TemplateManager.astro
// Modal to save current evaluation as a reusable template
---

<!-- Template Manager Modal (using native dialog with Terminal Luxe styling) -->
<dialog id="template-modal" class="modal">
  <div class="modal-box">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
    </form>

    <h3 class="font-display text-2xl font-semibold mb-2 text-gold-accessible">Save as Template</h3>
    <p class="text-base-content/70 mb-6">Save this evaluation configuration for reuse.</p>

    <form id="template-form" class="space-y-5">
      <!-- Template Name -->
      <div class="form-control w-full">
        <label class="label" for="template-name">
          <span class="label-text font-medium">Template Name <span class="text-error">*</span></span>
        </label>
        <input
          type="text"
          id="template-name"
          name="name"
          required
          maxlength="100"
          placeholder="e.g., Code Review Prompt Test"
          class="input input-bordered w-full"
        />
      </div>

      <!-- Template Description -->
      <div class="form-control w-full">
        <label class="label" for="template-description">
          <span class="label-text font-medium">Description <span class="text-base-content/50">(optional)</span></span>
        </label>
        <textarea
          id="template-description"
          name="description"
          rows="3"
          maxlength="500"
          placeholder="Brief description of what this template evaluates..."
          class="textarea textarea-bordered w-full"
        ></textarea>
      </div>

      <!-- Summary of what will be saved -->
      <div class="bg-base-200 rounded-lg p-4 border border-base-content/10">
        <p class="text-xs font-semibold text-base-content/60 uppercase tracking-wider mb-3">WILL SAVE:</p>
        <ul id="template-summary" class="space-y-2 text-sm text-base-content/80">
          <!-- Populated by JavaScript -->
        </ul>
      </div>

      <!-- Error message -->
      <div id="template-error" class="hidden alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span id="template-error-text"></span>
      </div>

      <!-- Success message -->
      <div id="template-success" class="hidden alert alert-success">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>Template saved successfully!</span>
      </div>

      <!-- Actions -->
      <div class="modal-action">
        <button
          type="button"
          id="template-cancel-btn"
          class="btn btn-ghost min-w-28"
        >
          Cancel
        </button>
        <button
          type="submit"
          id="template-submit-btn"
          class="btn btn-luxe btn-luxe-primary min-w-28"
        >
          Save Template
        </button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
  import { addToast } from '../lib/toastStore';

  // Template Manager state
  interface TemplateData {
    instruction_text: string;
    model_ids: string[];
    accuracy_rubric: string;
    expected_output: string;
    partial_credit_concepts?: string[];
  }

  function initTemplateManager() {
    let pendingTemplateData: TemplateData | null = null;

    // DOM Elements
    const templateModal = document.getElementById('template-modal') as HTMLDialogElement;
    const templateForm = document.getElementById('template-form') as HTMLFormElement;
    const templateNameInput = document.getElementById('template-name') as HTMLInputElement;
    const templateDescriptionInput = document.getElementById(
      'template-description'
    ) as HTMLTextAreaElement;
    const templateSummary = document.getElementById('template-summary') as HTMLUListElement;
    const templateError = document.getElementById('template-error') as HTMLDivElement;
    const templateErrorText = document.getElementById('template-error-text') as HTMLSpanElement;
    const templateSuccess = document.getElementById('template-success') as HTMLDivElement;
    const templateSubmitBtn = document.getElementById('template-submit-btn') as HTMLButtonElement;
    const templateCancelBtn = document.getElementById('template-cancel-btn') as HTMLButtonElement;

    if (!templateModal || !templateForm) return;

    // Open template modal with evaluation data
    function openTemplateModal(data: TemplateData) {
      pendingTemplateData = data;

      // Reset form
      templateForm.reset();
      templateError.classList.add('hidden');
      templateSuccess.classList.add('hidden');
      templateSubmitBtn.disabled = false;
      templateSubmitBtn.textContent = 'Save Template';

      // Populate summary
      const instructionPreview =
        data.instruction_text.length > 50
          ? data.instruction_text.substring(0, 50) + '...'
          : data.instruction_text;

      templateSummary.innerHTML = `
        <li><strong>Instruction:</strong> "${instructionPreview}"</li>
        <li><strong>Models:</strong> ${data.model_ids.length} selected</li>
        <li><strong>Rubric:</strong> ${formatRubric(data.accuracy_rubric)}</li>
      `;

      // Show modal
      templateModal.showModal();
      templateNameInput.focus();
    }

    function formatRubric(rubric: string): string {
      const rubricNames: Record<string, string> = {
        exact_match: 'Exact Match',
        partial_credit: 'Partial Credit',
        semantic_similarity: 'Semantic Similarity',
      };
      return rubricNames[rubric] || rubric;
    }

    // Cancel button handler
    if (templateCancelBtn) {
      templateCancelBtn.addEventListener('click', () => {
        templateModal.close();
      });
    }

    // Handle form submission
    templateForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!pendingTemplateData) {
        showTemplateError('No evaluation data to save');
        return;
      }

      const name = templateNameInput.value.trim();
      if (!name) {
        showTemplateError('Template name is required');
        return;
      }

      // Disable submit button
      templateSubmitBtn.disabled = true;
      templateSubmitBtn.textContent = 'Saving...';
      templateError.classList.add('hidden');

      try {
        const response = await fetch('/api/templates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            description: templateDescriptionInput.value.trim() || undefined,
            instruction_text: pendingTemplateData.instruction_text,
            model_ids: pendingTemplateData.model_ids,
            accuracy_rubric: pendingTemplateData.accuracy_rubric,
            expected_output: pendingTemplateData.expected_output,
            partial_credit_concepts: pendingTemplateData.partial_credit_concepts,
          }),
        });

        const data = await response.json();

        if (response.ok) {
          // Show success message
          templateSuccess.classList.remove('hidden');
          templateSubmitBtn.textContent = 'Saved!';

          // Show toast and close modal after delay
          addToast('Template saved successfully!', 'success');
          setTimeout(() => {
            templateModal.close();
            pendingTemplateData = null;
          }, 1500);
        } else {
          showTemplateError(data.message || data.error || 'Failed to save template');
          templateSubmitBtn.disabled = false;
          templateSubmitBtn.textContent = 'Save Template';
        }
      } catch {
        showTemplateError('Network error. Please try again.');
        templateSubmitBtn.disabled = false;
        templateSubmitBtn.textContent = 'Save Template';
      }
    });

    function showTemplateError(message: string) {
      if (templateErrorText) {
        templateErrorText.textContent = message;
      }
      templateError.classList.remove('hidden');
    }

    // Expose function globally for other pages to call
    (window as any).openTemplateModal = openTemplateModal;
  }

  // Initialize
  initTemplateManager();
  document.addEventListener('astro:page-load', initTemplateManager);
</script>
